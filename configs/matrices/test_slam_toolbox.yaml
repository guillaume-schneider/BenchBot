schema_version: 1
name: test_slam_toolbox
workspace:
  ros_distro: humble
  use_sim_time: true
defaults:
  run:
    warmup_s: 3.0  # Probes ensure system is ready, warmup just stabilizes metrics
    drain_s: 1.0
    timeout_s: 180.0
    max_restarts: 0
  rosbag:
    enabled: true
    storage_id: sqlite3
    topics:
    - /tf
    - /tf_static
    - /odom
    - /clock
    - /scan
    - /cmd_vel
    - /map
    - /map_metadata
    - /gazebo/model_states
    - /robot_description
  probes:
    required:
    - type: topic_publish
      topic: /scan
      msg_type: sensor_msgs/msg/LaserScan
      min_messages: 1
      timeout_s: 60
    - type: tf_available
      from_frame: map
      to_frame: odom
      timeout_s: 60
    - type: tf_available
      from_frame: base_footprint
      to_frame: odom
      timeout_s: 60
    - type: topic_publish
      topic: /map
      msg_type: nav_msgs/msg/OccupancyGrid
      min_messages: 1
      timeout_s: 60
datasets:
- id: tb3_sim_explore_modeA
  kind: sim_gazebo
  dependencies:
  - name: m-explore
    git: https://github.com/robo-friends/m-explore-ros2
    branch: main
    path: deps/m_explore_ws
    build: colcon build --symlink-install
    source: install/setup.bash
  scenario:
    processes:
    - name: nav2_sim
      cmd:
      - ros2
      - launch
      - ${PROJECT_ROOT}/tools/launch/tb3_sim_no_loc.launch.py
      - use_sim_time:=True
      - x_pose:=0.5
      - y_pose:=0.5
      - world:=${PROJECT_ROOT}/worlds/fixed_model.world
      - robot_sdf:=${PROJECT_ROOT}/worlds/waffle_fixed.model
      - use_gazebo:=False  # Disable gzclient to avoid graphical crashes
      - params_file:=${PROJECT_ROOT}/configs/params/nav2_params.yaml
      env:
        TURTLEBOT3_MODEL: waffle
    - name: explore
      delay_s: 6.0  # Increased to let Nav2 lifecycle nodes activate properly
      cmd:
      - ros2
      - launch
      - ${PROJECT_ROOT}/tools/launch/explore_with_qos.launch.py
      - use_sim_time:=True
      - params_file:=${PROJECT_ROOT}/configs/params/explore_params.yaml
      env:
        AMENT_PREFIX_PATH: ${PROJECT_ROOT}/deps/m_explore_ws/install/multirobot_map_merge:${PROJECT_ROOT}/deps/m_explore_ws/install/explore_lite:/opt/ros/humble
        LD_LIBRARY_PATH: ${PROJECT_ROOT}/deps/m_explore_ws/install/multirobot_map_merge/lib:/usr/lib/x86_64-linux-gnu/gazebo-11/plugins:/opt/ros/humble/opt/rviz_ogre_vendor/lib:/opt/ros/humble/lib/x86_64-linux-gnu:/opt/ros/humble/lib
        PYTHONPATH: ${PROJECT_ROOT}/deps/m_explore_ws/install/lib/python3.10/site-packages:/opt/ros/humble/lib/python3.10/site-packages:/opt/ros/humble/local/lib/python3.10/dist-packages
  world_model: worlds/model.sdf
slams:
- id: slam_toolbox_sync
  profile: configs/slams/slam_toolbox_sync.yaml
matrix:
  include:
  - dataset: tb3_sim_explore_modeA
    slams:
    - slam_toolbox_sync
    repeats: 1
    seeds:
    - 0
    tags:
    - single_test
    - slam_toolbox
    degradation:
      enabled: false
      max_range: 3.0
      noise_std: 0.05
      speed_scale: 1.0
output:
  root_dir: results/runs
  index_file: results/index.jsonl
  artifacts:
    export_map: true
