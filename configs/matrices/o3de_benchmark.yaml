schema_version: 1
name: o3de_benchmark
workspace:
  ros_distro: humble
  use_sim_time: true

defaults:
  run:
    warmup_s: 10.0
    drain_s: 5.0
    timeout_s: 300.0  # 5 minutes
  rosbag:
    enabled: true
    topics:
    - /tf
    - /tf_static
    - /odom
    - /scan
    - /map
    - /robot_description
    - /clock
  probes:
    required:
    - type: topic_publish
      topic: /scan
      msg_type: sensor_msgs/msg/LaserScan
      timeout_s: 60
    - type: topic_publish
      topic: /map
      msg_type: nav_msgs/msg/OccupancyGrid
      timeout_s: 60

datasets:
- id: tb3_o3de_benchmark
  kind: sim_o3de
  dependencies:
  - name: m-explore
    git: https://github.com/robo-friends/m-explore-ros2
    branch: main
    path: deps/m_explore_ws
    build: colcon build --symlink-install
    source: install/setup.bash
  simulator: o3de
  world_model: worlds/model.sdf
  scenario:
    processes:
    # 1. Nav2 Stack + SLAM + State Publisher
    # CRITICAL: use_simulator:=False prevents launching Gazebo (avoids Double-Sim Crash)
    - name: nav2_stack
      cmd:
      - ros2
      - launch
      - nav2_bringup
      - tb3_simulation_launch.py
      - slam:=True
      - use_simulator:=False
      - headless:=True
      - use_rviz:=False
      env:
        TURTLEBOT3_MODEL: waffle
        AMENT_PREFIX_PATH: /home/schneigu/Projects/benchbot/deps/m_explore_ws/install/multirobot_map_merge:/home/schneigu/Projects/benchbot/deps/m_explore_ws/install/explore_lite:/opt/ros/humble
        LD_LIBRARY_PATH: /home/schneigu/Projects/benchbot/deps/m_explore_ws/install/multirobot_map_merge/lib:/usr/lib/x86_64-linux-gnu/gazebo-11/plugins:/opt/ros/humble/opt/rviz_ogre_vendor/lib:/opt/ros/humble/lib/x86_64-linux-gnu:/opt/ros/humble/lib
        PYTHONPATH: /home/schneigu/Projects/benchbot/deps/m_explore_ws/install/lib/python3.10/site-packages:/opt/ros/humble/lib/python3.10/site-packages:/opt/ros/humble/local/lib/python3.10/dist-packages

    # 2. Explore Lite (Autonomous movement)
    - name: explore
      cmd:
      - ros2
      - launch
      - explore_lite
      - explore.launch.py
      - use_sim_time:=True
      env:
        TURTLEBOT3_MODEL: waffle
        AMENT_PREFIX_PATH: /home/schneigu/Projects/benchbot/deps/m_explore_ws/install/multirobot_map_merge:/home/schneigu/Projects/benchbot/deps/m_explore_ws/install/explore_lite:/opt/ros/humble
        LD_LIBRARY_PATH: /home/schneigu/Projects/benchbot/deps/m_explore_ws/install/multirobot_map_merge/lib:/usr/lib/x86_64-linux-gnu/gazebo-11/plugins:/opt/ros/humble/opt/rviz_ogre_vendor/lib:/opt/ros/humble/lib/x86_64-linux-gnu:/opt/ros/humble/lib
        PYTHONPATH: /home/schneigu/Projects/benchbot/deps/m_explore_ws/install/lib/python3.10/site-packages:/opt/ros/humble/lib/python3.10/site-packages:/opt/ros/humble/local/lib/python3.10/dist-packages

slams:
- id: noop
  profile: configs/slams/noop.yaml

matrix:
  include:
  - dataset: tb3_o3de_benchmark
    slams:
    - noop
    repeats: 1
    seeds: [0]

output:
  root_dir: results/runs
  artifacts:
    export_map: true
